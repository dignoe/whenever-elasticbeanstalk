#!/usr/bin/ruby
require 'rubygems'
gem 'aws-sdk'

require 'aws-sdk'
require 'erb'

bundle_exists = if RUBY_VERSION[0..2] == '1.8'
 Gem.available?('bundler')
else
 Gem::Specification::find_all_by_name('bundler').any?
end

environment = ENV["RAILS_ENV"]
AWS_CREDENTIALS = YAML.load(ERB.new(File.read("config/whenever-elasticbeanstalk.yml")).result)[ENV["RAILS_ENV"]]

instance_id = if File.exists?("/var/app/support/instance_id")
  File.read("/var/app/support/instance_id")
else
  if id = `/opt/aws/bin/ec2-metadata -i | awk '{print $2}'`.strip
    File.open("/var/app/support/instance_id", 'w') {|f| f.write(id) }
    id
  end
end

AWS.config(AWS_CREDENTIALS)
ec2 = AWS::EC2.new

if ec2.instances[instance_id].tags["leader"] == "true"
	if bundle_exists
		`bundle exec whenever --roles leader --set 'environment=#{environment}&path=/var/app/current' --update-crontab`
	else
		`whenever --roles leader --set 'environment=#{environment}&path=/var/app/current' --update-crontab`
	end
else
	if bundle_exists
		`bundle exec whenever --roles non-leader --set 'environment=#{environment}&path=/var/app/current' --update-crontab`
	else
		`whenever --roles non-leader --set 'environment=#{environment}&path=/var/app/current' --update-crontab`
	end
end
